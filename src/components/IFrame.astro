---
import { twMerge } from "tailwind-merge";

interface Props extends astroHTML.JSX.IframeHTMLAttributes {
  src: string;
  class?: string;
  loading?: "lazy" | "eager";
  teardownForBfcache?: boolean;
  placeholder?: string;
}

const {
  src,
  class: className = "",
  loading = "lazy",
  teardownForBfcache = true,
  placeholder = "Click to load live preview",
  ...props
} = Astro.props;

const eager = loading === "eager";
const id = `iframe-${crypto.randomUUID()}`;
---

<div class="relative">
  <iframe
    id={id}
    {...props}
    class={twMerge("w-full h-full", className)}
    src={eager ? src : "about:blank"}
    data-src={eager ? undefined : src}
    data-bfcache-teardown={teardownForBfcache ? "true" : "false"}
  />

  {!eager && (
    <button
      type="button"
      aria-controls={id}
      class="absolute inset-0 z-10 flex items-center justify-center rounded-lg bg-black/40 text-white backdrop-blur transition hover:bg-black/50"
      data-iframe-trigger
    >
      {placeholder}
    </button>
  )}
</div>

{!eager && (
  <script is:inline>
    (() => {
      const iframe = document.getElementById(`${JSON.stringify(id)}`);
      const btn = iframe?.parentElement?.querySelector("[data-iframe-trigger]");
      if (!iframe || !btn) return;

      btn.addEventListener("click", () => {
        const src = iframe.getAttribute("data-src");
        if (!src) return;
        iframe.src = src;
        iframe.removeAttribute("data-src");
        btn.remove();
      });
    })();
  </script>
)}

{teardownForBfcache && (
  <script is:inline>
    (() => {
      const iframe = document.getElementById(`${JSON.stringify(id)}`);
      if (!iframe) return;

      const teardown = () => {
        if (iframe.getAttribute("data-bfcache-teardown") !== "true") return;
        iframe.src = "about:blank";
      };

      window.addEventListener("pagehide", teardown);
      document.addEventListener("astro:before-swap", teardown);
    })();
  </script>
)}
